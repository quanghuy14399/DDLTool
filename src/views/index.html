<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Document</title>
</head>
<style>
  * {
    box-sizing: border-box;
  }

  .container {
    justify-content: space-around;
  }

  .space {
    height: 20px;
  }

  .w-200 {
    width: 200px;
  }

  .mt-20 {
    margin-top: 20px;
  }
  /* width */
  ::-webkit-scrollbar {
    width: 5px;
    height: 5px;
  }
  /* Track */
  ::-webkit-scrollbar-track {
    background: transparent;
    border-radius: 10px;
  }

  /* Handle */
  ::-webkit-scrollbar-thumb {
    border-radius: 10px;
    background: #888;
  }

  /* Handle on hover */
  ::-webkit-scrollbar-thumb:hover {
    background: #555;
  }
  .table {
    border: 1px solid #8ea8bf;
    border-radius: 20px;
    padding: 20px 10px;
    padding-right: 0;
  }

  .table .table-scrollbar {
    height: 300px;
    overflow: auto;
  }

  th { 
    position: sticky; 
    top: -1px;
    z-index: 2;
  }
  table {
    white-space: nowrap;
    border-collapse: collapse;
    position: relative;
  }
  .border-upload {
    text-align: center;
    border: 1px dashed #8ea8bf;
    border-radius: 20px;
    padding: 20px 10px;
  }

  #customers {
    font-family: Arial, Helvetica, sans-serif;
    width: 100%;
  }

  #customers td,
  #customers th {
    border: 1px solid #ddd;
    padding: 8px;
  }

  #customers td .content {
    min-width: 200px;
    white-space: break-spaces;
  }
  #customers tr:nth-child(even) {
    background-color: #f2f2f2;
  }

  #customers tr:hover {
    background-color: #ddd;
  }

  #customers th {
    padding-top: 12px;
    padding-bottom: 12px;
    text-align: left;
    background-color: #8ea8bf;
    color: black;
  }

  .container {
    display: flex;
  }

  .sidebar-left {
    width: 60%;
  }

  .sidebar-right {
    width: 30%;
  }

  .title-table {
    text-align: left;
  }

  .display-none {
    display: none;
  }

  .sidebar-right .upload-file .img-upload img {
    width: 50px;
  }

  .sidebar-right .upload-file .img-upload p {
    margin-top: 10px;
  }

  .button {
    background-color: #13aa52;
    border: 1px solid #13aa52;
    border-radius: 4px;
    box-shadow: rgba(0, 0, 0, 0.1) 0 2px 4px 0;
    box-sizing: border-box;
    color: #fff;
    cursor: pointer;
    font-family: 'Akzidenz Grotesk BQ Medium', -apple-system, BlinkMacSystemFont,
      sans-serif;
    font-size: 16px;
    font-weight: 400;
    outline: none;
    outline: 0;
    padding: 10px 25px;
    text-align: center;
    transform: translateY(0);
    transition: transform 150ms, box-shadow 150ms;
    user-select: none;
    -webkit-user-select: none;
    touch-action: manipulation;
  }

  .button-37:hover {
    box-shadow: rgba(0, 0, 0, 0.15) 0 3px 9px 0;
    transform: translateY(-2px);
  }

  @media (min-width: 768px) {
    .button-37 {
      padding: 10px 30px;
    }
  }

  .mt-20 {
    margin-top: 20px;
  }

  .detail-table .table .detail-information {
    display: flex;
    justify-content: space-between;
  }

  .switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
  }

  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    -webkit-transition: .4s;
    transition: .4s;
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    -webkit-transition: .4s;
    transition: .4s;
  }

  input:checked+.slider {
    background-color: #2196F3;
  }

  input:focus+.slider {
    box-shadow: 0 0 1px #2196F3;
  }

  input:checked+.slider:before {
    -webkit-transform: translateX(26px);
    -ms-transform: translateX(26px);
    transform: translateX(26px);
  }

  /* Rounded sliders */
  .slider.round {
    border-radius: 34px;
  }

  .slider.round:before {
    border-radius: 50%;
  }

  .switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
  }

  .switch input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    -webkit-transition: .4s;
    transition: .4s;
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    -webkit-transition: .4s;
    transition: .4s;
  }

  input:checked+.slider {
    background-color: #2196F3;
  }

  input:focus+.slider {
    box-shadow: 0 0 1px #2196F3;
  }

  input:checked+.slider:before {
    -webkit-transform: translateX(26px);
    -ms-transform: translateX(26px);
    transform: translateX(26px);
  }

  /* Rounded sliders */
  .slider.round {
    border-radius: 34px;
  }

  .slider.round:before {
    border-radius: 50%;
  }

  .icon-enabled,
  .button-table {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .icon-enabled {
    padding-right: 10px;
  }

  .mx-auto {
    margin: 0 auto;
  }

  .save-table .block-input {
    margin-top: 20px;
  }

  .save-table .block-input input[type='text']  {
    padding: 5px 12px;
  }

  .row {
    display: flex;
    justify-content: flex-start;
    align-items: flex-end;
    gap: 100px;
  }

  .row .col-md-6 h2 {
    line-height: 32px;
  }

  .text-center {
    text-align: center;
  }

  .title-small {
    font-size: 16px;
    font-weight: 700;
    padding-right: 20px;
  }

  /* modal */
  .details-modal {
    background: #fff;
    border-radius: 0.5em;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    left: 50%;
    max-width: 90%;
    pointer-events: none;
    position: absolute;
    top: 50%;
    transform: translate(-50%, -50%);
    width: 40vw;
    text-align: left;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    z-index: 3;
  }
  .details-modal .details-modal-title {
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: #111827;
    padding: 1.5em 2em;
    pointer-events: all;
  }
  .details-modal .details-modal-title h1 {
    font-size: 1.25rem;
    font-weight: 600;
    line-height: normal;
  }
  .details-modal .details-modal-content {
    border-top: 1px solid #e0e0e0;
    padding: 2em;
    pointer-events: all;
    overflow: auto;
  }
  .details-modal .details-modal-content .field-edit {
    display: flex;
    align-items: center;
  }
  .details-modal .details-modal-content .field-edit label {
    display: block;
    flex: 1;
  }
  .details-modal .details-modal-content .field-edit input {
    display: block;
    flex: 3;
    margin-left: 8px;
    padding: 5px 12px;
  }
  .details-modal .details-modal-content .field-edit .input-checkbox {
    flex: 3;
  }
  .details-modal .details-modal-content .field-edit input[type = 'checkbox'] {
    padding: 0;
    margin: 0;
  }
  .details-modal-overlay {
    transition: opacity 0.2s ease-out;
    pointer-events: all;
    background: rgba(15, 23, 42, 0.8);
    position: fixed;
    opacity: 0.5;
    bottom: 0;
    right: 0;
    left: 0;
    top: 0;
  }

  .d-none {
    display: none;
  }

  .button.disabled {
    pointer-events: none;
    background-color: #555;
    border: #555;
  }
 
</style>

<body>
  <div>
    <h1 class="text-center">DDL Tool</h1>
    <div class="container">
      <section class="sidebar-left">
        <div class="history-table">
          <h2 class="title-table">HISTORY TABLE</h2>
          <div class="table">
            <div class="table-scrollbar">
              <table id="customers" class="all">
                <thead>
                  <tr>
                    <th>No.</th>
                    <th>Ver.</th>
                    <th>Date</th>
                    <th>Table Name</th>
                    <th>Table Define Name</th>
                    <th id="active-history-show">History</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td>1</td>
                    <td>1.0</td>
                    <td>30/08/2022</td>
                    <td>Acount</td>
                    <td>Acount</td>
                    <td>
                      <input type="checkbox" name="history" id="history">
                    </td>
                  </tr>
                </tbody>
              </table>
          </div>
        </div>
        <div class="space"></div>
        <div class="detail-table">
          <h2 class="title-table">DETAIL TABLE</h2>
          <div class="table">
            <div class="detail-information align-center mb-5">
              <p class="mb-0">
                <strong>Table:</strong> Account
                <span><strong>Version:</strong> 1.0</span>
              </p>
              <div class="button-table d-flex">
                <div class="button w-16 disabled" id="btn-re-execute" disabled><span>Execute</span></div>
                <div class="icon-enabled">
                  <p class="mb-0 ml-2 mr-2" id="active-history-edit"><strong>Edit</strong></p>
                  <label class="switch">
                    <input type="checkbox" id="enabled-history-edit">
                    <span class="slider round"></span>
                  </label>
                </div>
              </div>
            </div>
            <div class="table-scrollbar">
              <table id="customers" class="one">
                <thead>
                  <tr>
                    <th>COLUMN NAME</th>
                    <th>DATA TYPE</th>
                    <th>SIZE</th>
                    <th>KEY</th>
                    <th>ALLOW NULL</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- <tr>
                    <td>Account</td>
                    <td>varchar</td>
                    <td>50</td>
                    <td><input type="checkbox" name="history1" id="history1"></td>
                    <td><input type="checkbox" name="history2" id="history2"></td>
                  </tr> -->
                </tbody>
              </table>
            </div>
            
          </div>
        </div>
      </section>
      <section class="sidebar-right">
        <div class="upload-file">
          <h2 class="title-upload">Upload File</h2>
          <div class="border-upload">
            <input id="input" type="file" name="excel" class="display-none" onchange="readFile()" />
            <label for="input">
              <div class="space"></div>
              <div class="img-upload">
                <img src="/images/upload-icon.png" alt="Upload" />
              </div>
              <small>File format: xlsx, xls</small>
              <div class="space"></div>
              <div class="button mx-auto w-200">BROWSE</div>
              <P>Maximun size: 10MB</P>
            </label>
          </div>
        </div>
        <div class="save-table">
          <div class="block-input">
            <!-- <v-text-field label="SCHEMA名" hide-details="auto" class="mb-6"></v-text-field> -->
            <label for="SCHEMA"><span class="title-small">SCHEMA名</span><input type="text" id="SCHEMA"></label>
            <div class="row">
              <div class="col-md-6">
                <h2>共通項目</h2>
                <label><input type="radio" name="cmnItemFlg" value="1" checked>使用<br/></label>
                <label><input type="radio" name="cmnItemFlg" value="0">未使用</label>
              </div>
              <div class="col-md-6">
                <h2>TBL存在チェック</h2>
                <label><input type="radio" name="checkExistTable" value="1" checked>必要<br /></label>
                <label><input type="radio" name="checkExistTable" value="0">不要</label>
              </div>
            </div>
          </div>
          <div class="space"></div>
          <div class="button mx-auto w-200" id="btn-save-table">SAVE TABLE</div>
        </div>
      </section>
    </div>
    <section id="modal-popup" class="d-none">
      <div class="details-modal-overlay"></div>
      <div class="details-modal">
        <div class="details-modal-title"> 
          <h1>Edit Detail Table</h1>
          <div class="details-modal-close">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 14 14" fill="none">
              <path fill-rule="evenodd" clip-rule="evenodd" d="M13.7071 1.70711C14.0976 1.31658 14.0976 0.683417 13.7071 0.292893C13.3166 -0.0976311 12.6834 -0.0976311 12.2929 0.292893L7 5.58579L1.70711 0.292893C1.31658 -0.0976311 0.683417 -0.0976311 0.292893 0.292893C-0.0976311 0.683417 -0.0976311 1.31658 0.292893 1.70711L5.58579 7L0.292893 12.2929C-0.0976311 12.6834 -0.0976311 13.3166 0.292893 13.7071C0.683417 14.0976 1.31658 14.0976 1.70711 13.7071L7 8.41421L12.2929 13.7071C12.6834 14.0976 13.3166 14.0976 13.7071 13.7071C14.0976 13.3166 14.0976 12.6834 13.7071 12.2929L8.41421 7L13.7071 1.70711Z" fill="black" />
            </svg>
          </div>
        </div>
        <div class="details-modal-content">
          <p>
            You can click the X in the corner or click the overlay to close this modal.
            Something like this could be useful as a nice way to show additional information,
            but that's about as far as I would take it. It's just a nice way of styling the details element.
          </p>
        </div>
      </div>
    </section>
  </div>
</body>
<script src="https://unpkg.com/read-excel-file@5.x/bundle/read-excel-file.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
  // import { readSheetNames } from 'read-excel-file'
  // import readXlsxFile from 'read-excel-file'
  const DEFINE_UNUSED_TABLE = [
    '表紙',
    '改修履歴',
    '修正ルール',
    'テーブル一覧',
    '目次',
  ]
  const DEFINE_TABLE = 'テーブル定義'
  const tbCellCommon = {
    titleTable: '',
    nameSystem: '',
    nameSystemChild: '',
    nameFunction: '',
    nameBusiness: '',
    version: '',
    admit: '',
    inspection: '',
    responsiblePerson: '',
    registrationNumber: '',
    referenceNumber: '',
    maker: '',
    updater: '',
    tableName: '',
    tableDefinitionName: '',
    nameDB: '',
    kinds: '',
    withHistoryTable: '',
    remarks: '',
  }
  const SHEET_LIST_NAME_TABLE = 'テーブル一覧'
  const allFieldsTB = []
  // const listTableTemp = []
  let dataBaseSelected = {}
  let indexSelected = 0
  let cellEdit = {}

  // modal
  const popupElement = document.querySelector('#modal-popup')
  const closePopupElement = popupElement.querySelector('.details-modal-close')
  
  // close the modal popup
  const closeTheModalPopup = () => {
    const elementData = popupElement.querySelectorAll('input')
    elementData.forEach((element) => {
      let value = element.value
      const idValue = element.getAttribute('id')
      cellEdit = {
        ...cellEdit,
        [`${idValue}`] : value
      }
    })
    dataBaseSelected.tableColInfos[indexSelected] = {
      ...cellEdit
    }
    const positionTableTbody = document.querySelector('#customers.one tbody')
    const positionTableThead = document.querySelector('#customers.one thead')
    // render detail table
    renderTable(dataBaseSelected.tableColInfos, positionTableTbody, positionTableThead)
    catchElementClicked(dataBaseSelected.tableColInfos)
    const enableBtnReExecute = document.querySelector('#btn-re-execute')
    enableBtnReExecute.classList.remove('disabled')
    popupElement.style.display = 'none'
  }
  closePopupElement.addEventListener('click', () => {
    popupElement.style.display = 'none'
  });

  // check enabled edit detail table
  const editDetailsTable = document.querySelector('#enabled-history-edit')
  const tableEdit = document.querySelector('#customers.one')
  editDetailsTable.checked = false
  tableEdit.style.pointerEvents  = 'none'
  editDetailsTable.addEventListener('change', () => {
    if (editDetailsTable.checked) {
      tableEdit.style.pointerEvents  = 'all'
    } else {
      tableEdit.style.pointerEvents  = 'none'
    }
  })

  // call data from DB
  const callDB = async () => {
    await axios
      .post("/table-list", {})
      .then((response) => {
        const positionTableTbody = document.querySelector('#customers.all tbody')
        const positionTableThead = document.querySelector('#customers.all thead')
        console.log(response.data, 'done processing')
        
        // render table all from DB
        renderTable(response.data, positionTableTbody, positionTableThead)
        const elementClicked = document.querySelectorAll('#customers.all tbody tr')
        elementClicked.forEach((element, index) => {
          element.addEventListener('click', () => {
            dataBaseSelected = {
              ...response.data[index]
            }
            let payload
            const positionTableTbody = document.querySelector('#customers.one tbody')
            const positionTableThead = document.querySelector('#customers.one thead')
            // render detail table
            renderTable(response.data[index].tableColInfos, positionTableTbody, positionTableThead)
            catchElementClicked(response.data[index].tableColInfos)
          })
        })
      })
      .catch((error) => {
        console.log(error);
      });
  }
  callDB()

  const catchElementClicked = (data) => {
    const elementClided = document.querySelectorAll('#customers.one tbody tr')
    elementClided.forEach((element, index) => {
      element.addEventListener('click', () => {
        indexSelected = index
        popupElement.style.display = 'block'
        const positionRenderData = document.querySelector('.details-modal-content')
        const dataRender = data[element.getAttribute('id')]
        let templatedData = ``
        for (const key in dataRender) {
          if (Object.hasOwnProperty.call(dataRender, key)) {
            // create input type checkbox
            if(key === 'primaryKey' || key === 'allowNulls' || key === 'identity') {
              templatedData += `
                <div class="field-edit">
                  <label for="${key}">${key}</label>
                  <div class="input-checkbox">
                  <input type="checkbox" id="${key}" name="${key}" ${dataRender[key] === '1' ? 'checked' : ''} value="${dataRender[key]}">
                  </div>
                </div>
                <div class="space"></div>
              `
            }
            else 
            templatedData += `
              <div class="field-edit">
                <label for="${key}">${key}</label>
                <input type=${typeof dataRender[key]} id="${key}" name="${key}" value="${dataRender[key]}">
              </div>
              <div class="space"></div>
            `
          }
        }
        positionRenderData.innerHTML = templatedData + `<div class="button" id="save-data-change">Save</div>`

        // addEventListener change on checkbox input
        for (const key in dataRender) {
          if (Object.hasOwnProperty.call(dataRender, key)) {
            if(key === 'primaryKey' || key === 'allowNulls' || key === 'identity') {
              const checkbox = document.querySelector('#' + key);
              checkbox.addEventListener('change',  () => {
                checkbox.value = checkbox.checked ? 1 : 0;
              });
            }
          }
        }

        const saveDataChange = document.querySelector('#save-data-change')
        saveDataChange.addEventListener('click', closeTheModalPopup)
      })
    })
  }
  
  // catch click btn-re-execute
  const eventSaveTable = document.querySelector("#btn-re-execute")
  eventSaveTable.addEventListener("click", () => {
    console.log('clicked btn-re-execute');
    
    const dataExecute = JSON.stringify(dataBaseSelected);
    console.log(dataExecute, 'data execute');
  });
  
  const renderTable = (datas, tbody, thead) => {
    let nameHeader = []
    let stringHeader = ``
    tbody.innerHTML = ``
    thead.innerHTML = ``
    // render data to table tbody 
    datas.forEach((data, index) => {
      let subElement = ''
      for(let key in data) {
        let value = data[key];
        if (index === 1)
          nameHeader.push(key)
        if (key === 'tableColInfos') {
          // tableColInfo ko render ra table
          continue
        } else if (key === 'primaryKey' || key === 'allowNulls' || key === 'identity') {
          subElement += `<td><input type="checkbox" ${value === '1' ? 'checked' : ''} disabled="true" /></td>`
        } else {
          subElement += `<td><div class="content">${value}</div></td>`
        }
      }
      tbody.innerHTML += `
        <tr id="${index}">
          ${subElement}
        </tr>
      `
    })
    // create table thead
    nameHeader.forEach((header, index) => {
      if ( header != 'tableColInfos' )
        stringHeader += `
          <th>${header}</th>
        `
    })
    thead.innerHTML = `
      <tr>
        ${stringHeader}
      </tr>
    `
  }

  const searchNameTable = async (sheetNames) => {
    const data = []
    const listTemp = []
    await sheetNames.forEach( async (element, indexSheet, arr) => {
      // if (DEFINE_UNUSED_TABLE.includes(element)) {
      //   return false
      // }
      let indexCustom = 0
      if (element === SHEET_LIST_NAME_TABLE) {
        await readXlsxFile(input.files[0], { sheet: element }).then( async (rows) => {
          const rowLenght = rows.length
          for (let index = 7; index < rowLenght; index++) {
            if (rows[index][3] === null) return
            listTemp.push(`${nullToEmptyString(rows[index][8])}`)
            indexCustom++
          }
        }).finally(() => {
          data.push(...searchSheetName(listTemp, sheetNames))
          if (!data.length) return alert('Sheet is not available')
        })
      }
      
    })
    return data
  }
  // search sheet name 
  const searchSheetName = (listTemp, sheetNames) => {
    const data = []
    listTemp.forEach((sheetNamesSelected, index) => {
      sheetNames.filter((sheetname) => {
        if (sheetname.indexOf(sheetNamesSelected) >= 0) {
          data.push(sheetname)
        }
      })
    })
    return data
  }
  // listTableTemp
  
  const readFile = async () => {
    const input = document.getElementById('input')
    const tbField = {}
    
    const sheetNames = await readXlsxFile(input.files[0], {
      getSheets: true
    }).then(function (sheets) {
      return sheets.map(function (sheet) {
        return sheet.name;
      });
    });

    const listTableTemp = await searchNameTable(sheetNames)
    setTimeout(async function() {
      if (!listTableTemp.length) return alert('Sheet is not available')
      console.log(listTableTemp); // will show devices array
      const lastItem = listTableTemp.length - 1
      let error = false
      await listTableTemp.forEach( async (element, index) => {
        await readXlsxFile(input.files[0], { sheet: element }).then((rows) => {
          tbCellCommon.nameSystem = nullToEmptyString(rows[1][17])
          tbCellCommon.titleTable = nullToEmptyString(rows[2][1])
          tbCellCommon.nameSystemChild = nullToEmptyString(rows[3][17])
          tbCellCommon.nameFunction = nullToEmptyString(rows[1][36])
          tbCellCommon.nameBusiness = nullToEmptyString(rows[3][36])
          tbCellCommon.version = nullToEmptyString(rows[3][48])
          tbCellCommon.admit = nullToEmptyString(rows[3][51])
          tbCellCommon.inspection = nullToEmptyString(rows[3][54])
          tbCellCommon.responsiblePerson = nullToEmptyString(rows[3][57])
          tbCellCommon.registrationNumber = nullToEmptyString(rows[1][70])
          tbCellCommon.referenceNumber = nullToEmptyString(rows[2][70])
          tbCellCommon.maker =
            nullToEmptyString(rows[3][70]) +
            nullToEmptyString(rows[3][76])
          tbCellCommon.updater =
            nullToEmptyString(rows[4][70]) +
            nullToEmptyString(rows[4][76])
          tbCellCommon.tableName = nullToEmptyString(rows[6][6])
          tbCellCommon.tableDefinitionName = nullToEmptyString(rows[6][22])
          tbCellCommon.nameDB = nullToEmptyString(rows[6][39])
          let kindRows = ''
          for (let index = 55; index < 69; index++) {
            kindRows =
              nullToEmptyString(kindRows) +
              nullToEmptyString(rows[6][index])
          }
          tbCellCommon.kinds = kindRows
          tbCellCommon.withHistoryTable = nullToEmptyString(rows[7][9])
          tbCellCommon.remarks = nullToEmptyString(rows[7][17])
          // console.log(rows)
          let tableColInfos = getDataOfField(rows)
          let fieldKey= {
            ...getDataOfFieldKey(rows)
          }
          allFieldsTB.push({ ...tbCellCommon, tableColInfos , fieldKey })
          if(index === lastItem) {
            allFieldsData(allFieldsTB)
          }
        })
        .catch((e) => {
          console.log(e, 'Exception');
          error = true
        })
        .finally(() => {
          
        })
        
      })
    },1000)
  }

  const allFieldsData = (data) => {
    console.log(data, 'done');
  }

  const nullToEmptyString = (value) => {
    return value === null ? '' : value
  }

  const getDataOfFieldKey = (value) => {
    const KEY_P_S = [35, 37, 39, 41, 43]
    const keyP = []
    const keyS1 = []
    const keyS2 = []
    const keyS3 = []
    const keyS4 = []
    const data = {};
    const rowLenght = value.length
    KEY_P_S.forEach((element) => {
      for (let indexSub = 12; indexSub < rowLenght; indexSub++) {
        if ((value[indexSub][3]) === null) return
        
        if (value[indexSub][element]) {
          if (element === 35) {
            let dataTemp = value[indexSub][16]
            keyP.push(dataTemp)
          }
          if (element === 37) {
            let dataTemp = value[indexSub][16]
            keyS1.push(dataTemp)
          }
          if (element === 39) {
            let dataTemp = value[indexSub][16]
            keyS2.push(dataTemp)
          }
          if (element === 41) {
            let dataTemp = value[indexSub][16]
            keyS3.push(dataTemp)
          }
          if (element === 43) {
            let dataTemp = value[indexSub][16]
            keyS4.push(dataTemp)
          }
          
        }
      }
    })
    data.p = keyP
    data.s1 = keyS1
    data.s2 = keyS2
    data.s3 = keyS3
    data.s4 = keyS4
    
    return data
  }

  const getDataOfField = (value) => {
    // const POSITION = [3, 16, 26, 30, 33, 35, 37, 39, 41, 43, 45, 48, 51, 54] //có dùng từ viết tắt
    const POSITION = [3, 16, 26, 30, 35, 37, 39, 41, 43, 45, 48, 51, 54]
    const KEY_P_S = [35, 37, 39, 41, 43]
    const FIELD_NAME = [ 'columnName', 'columnDefineName', 'dataType', 'size', 'primaryKey', 'keyS1' ,'keyS2' ,'keyS3' ,'keyS4' ,'allowNulls' , 'defaultValue', 'identity', 'description']
    const data = [];
    const rowLenght = value.length
    for (let indexSub = 12; indexSub < rowLenght; indexSub++) {
      let dataTemp = []
      const obj = {};
      if ((value[indexSub][3]) === null) return data
      POSITION.forEach((el, index, array) => {
        if (el === 48) {
          value[indexSub][el] === null ? value[indexSub][el] = null : value[indexSub][el] === "空" ? value[indexSub][el] = '' : value[indexSub][el]
        }
        dataTemp.push(value[indexSub][el])

        if (index === array.length -1) {
          FIELD_NAME.forEach((element, idx) => {
            obj[element] = dataTemp[idx];
          });
          data.push(obj)
        }
      })
      // if (indexSub === rowLenght -1) {
      //   return data
      // }
    }
  }

  // btn-save-table
  let controlRender = 0
  const btnSaveTable = document.querySelector('#btn-save-table')
  btnSaveTable.addEventListener('click', () => {
    controlRender++
    console.count('btn-save-table clicked');
    if (controlRender === 1)
      generator()
    axios
      .post("/table-registration", {...allFieldsTB[0]})
      .then((response) => {
        console.log(response.data, 'done processing')
        alert('Insert Table Successful')
        controlRender = 0
        allFieldsTB.length = 0
        dataBaseSelected = {}
        cellEdit = {}
      })
      .catch((error) => {
        console.log(error);
      });
  })
  // generator
  const generator = async () => {
    const SCHEMA = document.querySelector('#SCHEMA')
    const cmnItemFlg = document.querySelectorAll('input[name="cmnItemFlg"]')
    const checkExistTable = document.querySelectorAll('input[name="checkExistTable"]')
    const toDay = new Date()
    const commonItem = [
      {
        columnName: "削除フラグ",
        columnDefineName: "DEL_FLG",
        dataType: "char",
        size: 1,
        primaryKey: null,
        keyS1: null,
        keyS2: null,
        keyS3: null,
        keyS4: null,
        allowNulls: "×",
        defaultValue: 0,
        identity: null,
        description: "0：未削除\n1：削除済"
      },
      {
        columnName: "作成者ID",
        columnDefineName: "CRE_USER_ID",
        dataType: "char",
        size: 6,
        primaryKey: null,
        keyS1: null,
        keyS2: null,
        keyS3: null,
        keyS4: null,
        allowNulls: null,
        defaultValue: null,
        identity: null,
        description: "INSERT時"
      },
      {
        columnName: "作成日時",
        columnDefineName: "CRE_DATETIME",
        dataType: "datetime2",
        size: null,
        primaryKey: null,
        keyS1: null,
        keyS2: null,
        keyS3: null,
        keyS4: null,
        allowNulls: null,
        defaultValue: null,
        identity: null,
        description: "INSERT時"
      },
      {
        columnName: "作成プログラムID",
        columnDefineName: "CRE_PROG_ID",
        dataType: "varchar",
        size: 13,
        primaryKey: null,
        keyS1: null,
        keyS2: null,
        keyS3: null,
        keyS4: null,
        allowNulls: null,
        defaultValue: null,
        identity: null,
        description: "INSERT時"
      },
      {
        columnName: "更新者ID",
        columnDefineName: "UPD_USER_ID",
        dataType: "char",
        size: 6,
        primaryKey: null,
        keyS1: null,
        keyS2: null,
        keyS3: null,
        keyS4: null,
        allowNulls: null,
        defaultValue: null,
        identity: null,
        description: "INSERT時、UPDATE時"
      },
      {
        columnName: "更新日時",
        columnDefineName: "UPD_DATETIME",
        dataType: "datetime2",
        size: null,
        primaryKey: null,
        keyS1: null,
        keyS2: null,
        keyS3: null,
        keyS4: null,
        allowNulls: null,
        defaultValue: null,
        identity: null,
        description: "INSERT時、UPDATE時"
      },
      {
        columnName: "更新プログラムID",
        columnDefineName: "UPD_PROG_ID",
        dataType: "varchar",
        size: 13,
        primaryKey: null,
        keyS1: null,
        keyS2: null,
        keyS3: null,
        keyS4: null,
        allowNulls: null,
        defaultValue: null,
        identity: null,
        description: "INSERT時、UPDATE時"
      },
      {
        columnName: "削除者ID",
        columnDefineName: "DEL_USER_ID",
        dataType: "char",
        size: 6,
        primaryKey: null,
        keyS1: null,
        keyS2: null,
        keyS3: null,
        keyS4: null,
        allowNulls: null,
        defaultValue: null,
        identity: null,
        description: "論理削除UPDATE時"
      },
      {
        columnName: "削除日時",
        columnDefineName: "DEL_DATETIME",
        dataType: "datetime2",
        size: null,
        primaryKey: null,
        keyS1: null,
        keyS2: null,
        keyS3: null,
        keyS4: null,
        allowNulls: null,
        defaultValue: null,
        identity: null,
        description: "論理削除UPDATE時"
      },
      {
        columnName: "削除プログラムID",
        columnDefineName: "DEL_PROG_ID",
        dataType: "varchar",
        size: 13,
        primaryKey: null,
        keyS1: null,
        keyS2: null,
        keyS3: null,
        keyS4: null,
        allowNulls: null,
        defaultValue: null,
        identity: null,
        description: "論理削除UPDATE時"
      },
      {
        columnName: "バージョン",
        columnDefineName: "VERSION",
        dataType: "bigint",
        size: null,
        primaryKey: null,
        keyS1: null,
        keyS2: null,
        keyS3: null,
        keyS4: null,
        allowNulls: "×",
        defaultValue: 1,
        identity: null,
        description: "更新時、削除時に1カウントアップする"
      },

    ]
    // toDay.toLocaleString()
    if (!allFieldsTB) return
    await allFieldsTB.forEach((fieldTable, index, arr) => {
      fieldTable.excuteDate = toDay.toLocaleString()
      fieldTable.schemaName = SCHEMA.value ? SCHEMA.value : 'SagawaTableCoreSystem'
      cmnItemFlg.forEach((ele, index, arr) => {
        if (ele.checked) fieldTable.cmnItemFlg = ele.value
        if (index === arr.length -1) {
          if (fieldTable.cmnItemFlg === "1") {
            fieldTable.tableColInfos.push(...commonItem)
          }
        }
      })
      
      checkExistTable.forEach(ele => {
        if (ele.checked) fieldTable.checkExistTable = ele.value
      })
      // check RRK
      if (fieldTable.withHistoryTable) {
        const tableDuplicate = {
          ...fieldTable
        }
        tableDuplicate.tableDefinitionName = 'RRK_' + fieldTable.tableDefinitionName
        tableDuplicate.fieldKey.p = ['RIREKI_SEQ']
        
        const RIREKI_SEQ = {
          columnName: "履歴SEQ",
          columnDefineName: "RIREKI_SEQ",
          dataType: "bigint",
          size: null,
          primaryKey: 1,
          keyS1: null,
          keyS2: null,
          keyS3: null,
          keyS4: null,
          allowNulls: "×",
          defaultValue: null,
          identity: "1,1",
          description: null
        }
        const RIREKI_CRE_DATETIME = {
          columnName: "履歴作成日時",
          columnDefineName: "RIREKI_CRE_DATETIME",
          dataType: "datetime2",
          size: null,
          primaryKey: null,
          keyS1: null,
          keyS2: null,
          keyS3: null,
          keyS4: null,
          allowNulls: "×",
          defaultValue: null,
          identity: null,
          description: null
        }
        tableDuplicate.tableColInfos.push(RIREKI_SEQ)
        tableDuplicate.tableColInfos.push(RIREKI_CRE_DATETIME)
        allFieldsTB[arr.length] = {
          ...tableDuplicate
        }
          
      }
    })
    console.log(allFieldsTB,'after all');

    // let fieldScript = allFieldsTB[0].fieldTemp.map((item) => (
    //                     `[${item.columnName}] [${item.dataType}]${item.size ? `(${item.size})` : ''} ${item.allowNulls ? 'NOT NULL' : 'NULL'} ${item.defaultValue ? item.defaultValue === '空' ? `DEFAULT ('')` : `DEFAULT (${item.defaultValue})` : ''}
    //                     `
    //                   ))
    // let keyPScript = allFieldsTB[0].fieldKey[0].map((field, index, arr) => (
    //                     field ? `[${field}] ASC
    //                     ` : ''
    //                   ))
    // let execScript = allFieldsTB[0].fieldTemp.map((item) => (
    //                     `EXEC sys.sp_addextendedproperty @name=N'MS_Description', @value=N'${item.columnDefineName}' , @level0type=N'SCHEMA',@level0name=N'dbo', @level1type=N'TABLE',@level1name=N'${item.tableDefinitionName}', @level2type=N'COLUMN',@level2name=N'${item.columnName}'
    //                     GO
    //                     `
    //                   ))
    // let keySScript = allFieldsTB[0].fieldKey.map((item, index) => {
    //                     if (index === 0) return
    //                     return item ? `
    //                     /****** Object:  Index [IDX0${index}_${allFieldsTB[0].tableDefinitionName}]    Script Date: ${toDay.toLocaleString()} ******/
    //                     DROP INDEX IF EXISTS [IDX0${index}_${allFieldsTB[0].tableDefinitionName}] ON [dbo].[${allFieldsTB[0].tableDefinitionName}]
    //                     GO

    //                     CREATE NONCLUSTERED INDEX [IDX0${index}_${allFieldsTB[0].tableDefinitionName}] ON [dbo].[${allFieldsTB[0].tableDefinitionName}]
    //                     (
    //                       ${item.map((item) => (
    //                         item ? `[${item}] ASC` : ''
    //                       ))}
    //                     )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
    //                     GO
    //                     ` : '';
    //                   })
    // let dataPost = `USE ${SCHEMA.value ? SCHEMA.value : '[SagawaCoreSystem]'}
    //       GO

    //       /****** ${allFieldsTB[0].tableName} ******/
    //       /****** Object:  Table [dbo].[${allFieldsTB[0].tableDefinitionName}]    Script Date: ${toDay.toLocaleString()} ******/
    //       SET ANSI_NULLS ON
    //       GO

    //       SET QUOTED_IDENTIFIER ON
    //       GO
    //       DROP TABLE IF EXISTS [dbo].[${allFieldsTB[0].tableDefinitionName}]
    //       GO

    //       CREATE TABLE [dbo].[${allFieldsTB[0].tableDefinitionName}](
    //       ${fieldScript}
    //       CONSTRAINT [PK_${allFieldsTB[0].tableDefinitionName}] PRIMARY KEY CLUSTERED 
    //       (
    //       ${keyPScript}
    //       )WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
    //       ) ON [PRIMARY]
    //       GO
    //       )
          
    //       ${execScript}
    //       ${keySScript}
          

    //        `
    // return dataPost
  }
</script>

</html>